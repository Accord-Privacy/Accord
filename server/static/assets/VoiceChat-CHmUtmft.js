import{r as a,g as T,e as O,j as o,d as P}from"./index-BAF5kJbA.js";import"./vendor-react-j2mp3VYR.js";const q=({ws:n,currentUserId:x,channelId:s,channelName:N,onLeave:A,privateKey:m})=>{const[i,g]=a.useState({channelId:null,isConnected:!1,isMuted:!0,isDeafened:!1,outputVolume:100,connectedUsers:[],isCapturingAudio:!1,vadThreshold:.01,isSpeaking:!1}),h=a.useRef(null),v=a.useRef(null),p=a.useRef(null),_=a.useRef(null),b=a.useRef(null),k=a.useRef(new Map),j=a.useRef(null),S=a.useRef(null),M=a.useCallback(async()=>{try{h.current=new(window.AudioContext||window.webkitAudioContext);const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});v.current=e,p.current=h.current.createAnalyser(),p.current.fftSize=2048,p.current.smoothingTimeConstant=.8,_.current=h.current.createMediaStreamSource(e),b.current=h.current.createScriptProcessor(4096,1,1),_.current.connect(p.current),p.current.connect(b.current),b.current.connect(h.current.destination),b.current.onaudioprocess=l=>{if(i.isMuted)return;const u=l.inputBuffer.getChannelData(0),d=new Int16Array(u.length);for(let r=0;r<u.length;r++)d[r]=Math.max(-1,Math.min(1,u[r]))*32767;const t=d.buffer,c=btoa(String.fromCharCode(...new Uint8Array(t)));n&&n.isSocketConnected()&&(async()=>{let y=c;if(m)try{const C=await T(m,s);y=await O(C,c)}catch{}n.send(JSON.stringify({type:"voice_packet",channel_id:s,user_id:x,data:y,encrypted:!!m}))})()},g(l=>({...l,isCapturingAudio:!0})),U()}catch(e){console.error("Failed to initialize audio:",e),alert("Failed to access microphone. Please check permissions.")}},[n,s,x,i.isMuted]),U=a.useCallback(()=>{j.current||(j.current=setInterval(()=>{if(!p.current||i.isMuted)return;const e=new Uint8Array(p.current.frequencyBinCount);p.current.getByteFrequencyData(e);const d=e.reduce((t,c)=>t+c,0)/e.length/255>i.vadThreshold;d!==i.isSpeaking&&(g(t=>({...t,isSpeaking:d})),n&&n.isSocketConnected()&&n.send(JSON.stringify({type:"voice_speaking",channel_id:s,user_id:x,speaking:d})),S.current&&clearTimeout(S.current),d||(S.current=setTimeout(()=>{g(t=>({...t,isSpeaking:!1})),n&&n.isSocketConnected()&&n.send(JSON.stringify({type:"voice_speaking",channel_id:s,user_id:x,speaking:!1}))},500)))},100))},[p,i.isMuted,i.vadThreshold,i.isSpeaking,n,s,x]),D=a.useCallback(()=>{j.current&&(clearInterval(j.current),j.current=null),S.current&&(clearTimeout(S.current),S.current=null)},[]),V=a.useCallback(async(e,l)=>{if(!i.isDeafened)try{const u=atob(l),d=new Uint8Array(u.length);for(let f=0;f<u.length;f++)d[f]=u.charCodeAt(f);const t=new Int16Array(d.buffer),c=new Float32Array(t.length);for(let f=0;f<t.length;f++)c[f]=t[f]/32767;let r=k.current.get(e);if(!r){const f=new(window.AudioContext||window.webkitAudioContext),R=f.createGain();R.connect(f.destination),R.gain.value=i.outputVolume/100,r={context:f,gainNode:R},k.current.set(e,r)}const y=r.context.createBuffer(1,c.length,44100);y.copyToChannel(c,0);const C=r.context.createBufferSource();C.buffer=y,C.connect(r.gainNode),C.start()}catch(u){console.error("Failed to play audio:",u)}},[i.isDeafened,i.outputVolume]),B=a.useCallback(async()=>{if(!i.isConnected)try{await M(),n&&n.isSocketConnected()&&n.send(JSON.stringify({type:"voice_join",channel_id:s,user_id:x})),g(e=>({...e,channelId:s,isConnected:!0}))}catch(e){console.error("Failed to connect to voice:",e)}},[M,n,s,x,i.isConnected]),z=a.useCallback(()=>{n&&n.isSocketConnected()&&n.send(JSON.stringify({type:"voice_leave",channel_id:s,user_id:x})),D(),b.current&&(b.current.disconnect(),b.current=null),_.current&&(_.current.disconnect(),_.current=null),p.current&&(p.current.disconnect(),p.current=null),v.current&&(v.current.getTracks().forEach(e=>e.stop()),v.current=null),h.current&&(h.current.close(),h.current=null),k.current.forEach(e=>{e.context.close()}),k.current.clear(),g(e=>({...e,channelId:null,isConnected:!1,connectedUsers:[],isCapturingAudio:!1,isSpeaking:!1})),A()},[n,s,x,D,A]),E=a.useCallback(()=>{g(e=>({...e,isMuted:!e.isMuted}))},[]),F=a.useCallback(()=>{g(e=>({...e,isDeafened:!e.isDeafened,isMuted:e.isDeafened?e.isMuted:!0}))},[]),J=a.useCallback(e=>{g(l=>({...l,outputVolume:Math.max(0,Math.min(100,e))})),k.current.forEach(l=>{l.gainNode.gain.value=e/100})},[]);return a.useEffect(()=>{if(!n)return;const e=t=>{t.channel_id===s&&g(c=>{var r,y;return{...c,connectedUsers:[...c.connectedUsers.filter(C=>C.userId!==t.user_id),{userId:t.user_id,displayName:((r=t.public_key_hash)==null?void 0:r.slice(0,16))||`User ${(y=t.user_id)==null?void 0:y.slice(0,8)}`,isSpeaking:!1,audioLevel:0}]}})},l=t=>{if(t.channel_id!==s)return;g(r=>({...r,connectedUsers:r.connectedUsers.filter(y=>y.userId!==t.user_id)}));const c=k.current.get(t.user_id);c&&(c.context.close(),k.current.delete(t.user_id))},u=async t=>{if(t.channel_id!==s||t.user_id===x)return;let c=t.data;if(t.encrypted&&m)try{const r=await T(m,s);c=await P(r,t.data)}catch{}V(t.user_id,c)},d=t=>{t.channel_id===s&&g(c=>({...c,connectedUsers:c.connectedUsers.map(r=>r.userId===t.user_id?{...r,isSpeaking:t.speaking}:r)}))};return n.on("voice_join",e),n.on("voice_leave",l),n.on("voice_packet",u),n.on("voice_speaking",d),()=>{n.off("voice_join",e),n.off("voice_leave",l),n.off("voice_packet",u),n.off("voice_speaking",d)}},[n,s,x,V]),a.useEffect(()=>(B(),()=>{z()}),[]),o.jsxs("div",{style:{position:"fixed",bottom:0,left:"312px",right:"240px",height:"120px",background:"#2f3136",borderTop:"1px solid #202225",display:"flex",flexDirection:"column",zIndex:1e3},children:[o.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid #202225",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[o.jsx("span",{style:{fontSize:"14px",fontWeight:600,color:"#43b581"},children:"ðŸ”Š Voice Connected"}),o.jsx("span",{style:{fontSize:"13px",color:"#b9bbbe"},children:N})]}),o.jsx("button",{onClick:z,style:{background:"#f04747",border:"none",color:"#ffffff",padding:"6px 12px",borderRadius:"4px",cursor:"pointer",fontSize:"12px"},children:"Disconnect"})]}),o.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 16px"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",flex:1},children:[o.jsxs("span",{style:{fontSize:"12px",color:"#8e9297",marginRight:"8px"},children:["Users (",i.connectedUsers.length+1,"):"]}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",padding:"4px 8px",borderRadius:"4px",background:i.isSpeaking?"rgba(67, 181, 129, 0.3)":"transparent",border:i.isSpeaking?"2px solid #43b581":"2px solid transparent",transition:"all 0.2s"},children:[o.jsx("div",{style:{width:"24px",height:"24px",borderRadius:"50%",background:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",color:"#fff"},children:"U"}),o.jsx("span",{style:{fontSize:"12px",color:"#dcddde"},children:"You"}),i.isMuted&&o.jsx("span",{style:{fontSize:"10px",color:"#f04747"},children:"ðŸ”‡"})]}),i.connectedUsers.map(e=>{var l;return o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",padding:"4px 8px",borderRadius:"4px",background:e.isSpeaking?"rgba(67, 181, 129, 0.3)":"transparent",border:e.isSpeaking?"2px solid #43b581":"2px solid transparent",transition:"all 0.2s"},children:[o.jsx("div",{style:{width:"24px",height:"24px",borderRadius:"50%",background:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",color:"#fff"},children:(l=e.displayName[0])==null?void 0:l.toUpperCase()}),o.jsx("span",{style:{fontSize:"12px",color:"#dcddde"},children:e.displayName})]},e.userId)})]}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[o.jsx("button",{onClick:E,style:{width:"36px",height:"36px",borderRadius:"50%",border:"none",background:i.isMuted?"#f04747":"#3ba55d",color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px"},title:i.isMuted?"Unmute":"Mute",children:i.isMuted?"ðŸ”‡":"ðŸŽ¤"}),o.jsx("button",{onClick:F,style:{width:"36px",height:"36px",borderRadius:"50%",border:"none",background:i.isDeafened?"#f04747":"#4f545c",color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px"},title:i.isDeafened?"Undeafen":"Deafen",children:i.isDeafened?"ðŸ”‡":"ðŸ”Š"}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",minWidth:"120px"},children:[o.jsx("span",{style:{fontSize:"12px",color:"#8e9297"},children:"Vol:"}),o.jsx("input",{type:"range",min:"0",max:"100",value:i.outputVolume,onChange:e=>J(parseInt(e.target.value)),style:{flex:1,height:"4px",borderRadius:"2px",background:"#4f545c",outline:"none",cursor:"pointer"}}),o.jsxs("span",{style:{fontSize:"11px",color:"#8e9297",minWidth:"25px"},children:[i.outputVolume,"%"]})]})]})]})]})};export{q as VoiceChat};
